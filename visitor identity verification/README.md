## Visitor Identity Verification

1) Overview
2) Creating the signature
3) Providing the required variables to SnapEngage
4) Code examples

### Overview

To allow the agent to verify the identity of a visitor and to prevent impersonation, you
can enable the Visitor Identity Verification in the admin dashboard. 
This works by providing a value(e.g. user id or user email) and an HMAC signature that has been generated  using given value to the SnapEngage code snippet on your website as JsVariable.  
Once a chat is started, the agent will be notified in the Hub if the identity verification was successful.

**NOTE: The verification secret that is used to generate the signature must be kept secret!  
Do not expose it on the website!**

### Creating the signature

When a chat is started on your website, the SnapEngage code snippet requires at least three JsVariables available on your website:  
`__hmacSignature`, `__hmacNonce` and `__hmacTimestamp`.  
If you chose to verify a JsVariable, then this needs to be provided as well.

##### Required values
* **Verification secret**: The same verification secret set in the dashboard.  
Example: `AuW5G710B_jOk7LeMq0BBZCcqoXrmpismsGVyeqmENlUDra1izI9AhI26QVpAx3MENP9bPmr5ViTHTEwp4W5Vw`  
* **Content to verify**: Any value that can verify the identity of a visitor.  
Example: `email@user.com`
* **Timestamp**: The current time in epoch(unix timestamp) milliseconds format.  
Example: `1600347324661`  
* **Nonce**: A unique string, for example a random UUID.  
Example: `7e0b4aa9-67ee-44d7-9c6c-8c255ab92cd1`

##### Create the signature

The signature is generated by hashing following concatenated string  
using the *HmacSHA256* algorithm and the *verification secret*:  
`{content} + {nonce} + {timestamp}`  
Example concatenated string: `user@email.com7e0b4aa9-67ee-44d7-9c6c-8c255ab92cd11600347324661`

The get the final signature, the result needs to be ***hex encoded***.  
The final signature for the example values above is this:  
`0bb85191652e38fcc4a827447bb4ddeea2261cafc969924c27e234ba449dced9`

When implementing this, you can verify the correctness of your implementation  
by using the example values which should produce the same final result that is shown here.

### Providing the required variables to SnapEngage

Once all values have been generated on your backend, they need to be provided to SnapEngage via your website.  
To do so, the SnapEnagage code snippet will collect these JsVariables at the beginning of the chat:  
`__hmacSignature`, `__hmacNonce` and `__hmacTimestamp`.  

*Dont forget to replace the snapengage code with your own code snippet!!*
  
##### Code example when the content to verify is a Js Variable with the name `userEmail`:
```html
<script type="text/javascript">
var __hmacSignature = "0bb85191652e38fcc4a827447bb4ddeea2261cafc969924c27e234ba449dced9";
var __hmacNonce = "7e0b4aa9-67ee-44d7-9c6c-8c255ab92cd1";
var __hmacTimestamp = "1600347324661";
var userEmail = "email@user.com";
</script>

 <!-- begin SnapEngage code -->
<script type="text/javascript">
    // Go to https://www.snapengage.com/app/settings -> Get the code to get your snippet
  (function() {
    var se = document.createElement('script'); se.type = 'text/javascript'; se.async = true;
    se.src = '${here goes on the URL to your widget snippet}'; 
    var done = false;
    se.onload = se.onreadystatechange = function() {
      if (!done&&(!this.readyState||this.readyState==='loaded'||this.readyState==='complete')) {
        done = true;
      }
    };
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(se, s);
  })();
</script>
<!-- end SnapEngage code -->
```

##### Code example when the content to verify is the case email:
```html
<script type="text/javascript">
var __hmacSignature = "0bb85191652e38fcc4a827447bb4ddeea2261cafc969924c27e234ba449dced9";
var __hmacNonce = "7e0b4aa9-67ee-44d7-9c6c-8c255ab92cd1";
var __hmacTimestamp = "1600347324661";
</script>

 <!-- begin SnapEngage code -->
<script type="text/javascript">
    // Go to https://www.snapengage.com/app/settings -> Get the code to get your snippet
  (function() {
    var se = document.createElement('script'); se.type = 'text/javascript'; se.async = true;
    se.src = '${here goes on the URL to your widget snippet}';
    var done = false;
    se.onload = se.onreadystatechange = function() {
      if (!done&&(!this.readyState||this.readyState==='loaded'||this.readyState==='complete')) {
        done = true;
        SnapEngage.setUserEmail('email@user.com'); // set the email via Prechat form, or here after loading the snippet
      }
    };
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(se, s);
  })();
</script>
<!-- end SnapEngage code -->
```

### Code examples

`${verificationSecret}` needs to be replaced with the secret that is set in the dashboard.  
`${concatenatedString}` needs to be replaced with the concatenated string as explained above.  

##### Java

```Java
import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;

public class HmacTest {
  public static void main(String[] args) {
  try {
      String secret = "${verificationSecret}";
      String message = "${concatenatedString}";

      Mac hmac = Mac.getInstance("HmacSHA256");
      SecretKeySpec key = new SecretKeySpec(secret.getBytes(StandardCharsets.UTF_8), "HmacSHA256");
      hmac.init(key);

      byte[] rawSignature = (hmac.doFinal(message.getBytes(StandardCharsets.UTF_8)));

      StringBuilder hmacSignature = new StringBuilder();
      for (byte b : rawSignature) {
        hmacSignature.append(String.format("%02x", b));
      }
      System.out.println(hmacSignature.toString());

      // Other options to create the hex string:
      // Guava: HashCode.fromBytes(rawSignature).toString()
      // Apache Commons: Hex.encodeHexString(rawSignature))
      // Spring: new String(Hex.encode(rawSignature))
    }
    catch (Exception e){
      System.out.println("Failed to create HmacSignature");
    }
  }
}
```

##### Python 3.X

```Python
import hashlib
import hmac

KEY = "${verificationSecret}"
KEY_BYTES = KEY.encode('ascii')

MESSAGE = "${concatenatedString}"
MESSAGE_BYTES = MESSAGE.encode('ascii')

hmacSignature = hmac.new(KEY_BYTES, MESSAGE_BYTES, hashlib.sha256).hexdigest()

print (hmacSignature)
```


##### Php

```php
    <?php
    echo hash_hmac('sha256', '${concatenatedString}', '${verificationSecret}', false);
    ?>
```

##### Node

```javascript
const crypto = require('crypto');
const hmac = crypto.createHmac('sha256', '${verificationSecret}');

hmac.update('${concatenatedString}');
var hmacSignatue = hmac.digest('hex');
```
